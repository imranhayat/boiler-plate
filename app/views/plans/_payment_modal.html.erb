<div class="modal fade" id="payment_modal_for_<%= plan_id %>" tabindex="-1" role="dialog" aria-labelledby="#payment_modal_<%= plan_id %>Label" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="#payment_modal_<%= plan_id %>Label">Enter your Card Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="subscription-for-<%= plan_id %>">
          <form>
            <div id="card-element" class="MyCardElement">
              <!-- Elements will create input elements here -->
            </div>
            <!-- We'll put the error messages in this element -->
            <div id="card-errors-<%= plan_id %>" role="alert"></div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">Subscribe</button>
          <form>
          <input type="hidden" id='stripe_plan_id_<%= plan_id %>', value='<%= plan_id %>' />
          <input type="hidden" id='app_plan_id_<%= app_plan_id %>', value='<%= app_plan_id %>' />
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var stripe_plan_id = document.getElementById('stripe_plan_id_<%= plan_id %>').value
  var app_plan_id = document.getElementById('app_plan_id_<%= app_plan_id %>').value

  var stripe = Stripe('<%= ENV['PUBLISHABLE_KEY'] %>');
  var elements = stripe.elements();
  var cardElement = elements.create('card', { hidePostalCode: true });
  
  cardElement.mount('#card-element');
  cardElement.addEventListener('change', ({error}) => {
    const displayError = document.getElementById('card-errors-<%= plan_id %>');
    if (error) {
      displayError.textContent = error.message;
    } else {
      displayError.textContent = '';
    }
  });
  
  var form = document.getElementById("subscription-for-<%= plan_id %>");
  form.addEventListener('submit', function(event) {
    // We don't want to let default form submission happen here,
    // which would refresh the page.
    event.preventDefault();
    stripe.createPaymentMethod({
      type: 'card',
      card: cardElement
    })
    .then(function(result) {
      if (result.error){
        console.log(result.error.message);
      } 
      else {
        createSubscription(result.paymentMethod)
      }
    });
  });

  function createSubscription(payment_method) {
    // Send paymentMethod.id to your server
    request = $.ajax({
      url: '/create_subscription',
      type: 'POST',
      dataType : 'script',
      beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
      data: { 
        payment_gateway: 'Stripe',
        payment_method: payment_method.id, 
        stripe_plan_id: stripe_plan_id,
        app_plan_id: app_plan_id
      }
    });
    request.done(function (response, textStatus, jqXHR){
      $('#payment_modal_for_<%= plan_id %>').modal('hide');
    });
  }
</script>